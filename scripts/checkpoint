#!/usr/bin/env python3
"""Manage conversation checkpoints.

Usage:
    checkpoint save <name>       # Save checkpoint at current turn
    checkpoint list              # List all checkpoints
    checkpoint restore <name>    # Branch from checkpoint
    checkpoint delete <name>     # Delete a checkpoint
"""

import argparse
import os
import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent))
from lib import checkpoint as cp


def get_conversation_id(args_conv):
    conv_id = args_conv or os.environ.get('SHELLEY_CONVERSATION_ID')
    if not conv_id:
        print("Error: No conversation. Set SHELLEY_CONVERSATION_ID or use -c", file=sys.stderr)
        sys.exit(1)
    return conv_id


def main():
    parser = argparse.ArgumentParser(description='Manage checkpoints')
    parser.add_argument('action', choices=['save', 'list', 'restore', 'delete'])
    parser.add_argument('name', nargs='?', help='Checkpoint name')
    parser.add_argument('-c', '--conversation', help='Conversation ID')
    args = parser.parse_args()
    
    if args.action == 'save':
        if not args.name:
            print("Error: save requires a name", file=sys.stderr)
            sys.exit(1)
        
        conv_id = get_conversation_id(args.conversation)
        result = cp.save_checkpoint(conv_id, args.name)
        print(f"Saved '{args.name}' at seq #{result['sequence_id']}")
        print(f"  {result['summary']}")
    
    elif args.action == 'list':
        conv_id = args.conversation or os.environ.get('SHELLEY_CONVERSATION_ID')
        checkpoints = cp.list_checkpoints(conv_id)
        
        if not checkpoints:
            print("No checkpoints.")
        else:
            for c in checkpoints:
                print(f"[{c['name']}] #{c['sequence_id']} - {c['summary'][:50]}")
                print(f"  {c['conversation_id']} ({c.get('slug', '')})")
    
    elif args.action == 'restore':
        if not args.name:
            print("Error: restore requires a name", file=sys.stderr)
            sys.exit(1)
        
        conv_id = get_conversation_id(args.conversation)
        new_id = cp.restore_checkpoint(conv_id, args.name)
        print(f"Restored to: {new_id}")
        print(f"http://localhost:9999/c/{new_id}")
    
    elif args.action == 'delete':
        if not args.name:
            print("Error: delete requires a name", file=sys.stderr)
            sys.exit(1)
        
        conv_id = get_conversation_id(args.conversation)
        if cp.delete_checkpoint(conv_id, args.name):
            print(f"Deleted '{args.name}'")
        else:
            print(f"Not found: '{args.name}'", file=sys.stderr)
            sys.exit(1)


if __name__ == '__main__':
    main()
