#!/usr/bin/env python3
"""Spawn a sub-agent to handle a task in a separate context.

Usage:
    spawn "task description"              # Wait for result
    spawn "task description" --async      # Return immediately
    spawn "task" --cwd /path/to/dir       # Set working directory
"""

import argparse
import json
import os
import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent))
from lib import shelley_api


def main():
    parser = argparse.ArgumentParser(description='Spawn a sub-agent')
    parser.add_argument('task', help='Task description for the sub-agent')
    parser.add_argument('--async', dest='async_mode', action='store_true', help='Return immediately')
    parser.add_argument('--cwd', help='Working directory for sub-agent')
    parser.add_argument('--model', default='claude-sonnet-4-20250514', help='Model to use')
    args = parser.parse_args()
    
    cwd = args.cwd or os.environ.get('SHELLEY_CWD', os.getcwd())
    
    print(f"Spawning: {args.task[:60]}{'...' if len(args.task) > 60 else ''}", file=sys.stderr)
    
    try:
        conv_id = shelley_api.create_conversation(args.task, cwd, args.model)
        print(f"Conversation: {conv_id}", file=sys.stderr)
        
        if args.async_mode:
            print(json.dumps({
                'conversation_id': conv_id,
                'status': 'running',
                'url': f"http://localhost:9999/c/{conv_id}"
            }))
        else:
            print("Waiting for completion...", file=sys.stderr)
            response = shelley_api.wait_for_completion(conv_id)
            result = shelley_api.extract_final_response(response)
            
            if result:
                print(result)
            else:
                print(json.dumps({
                    'conversation_id': conv_id,
                    'status': 'complete',
                    'result': None
                }))
    
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        sys.exit(1)


if __name__ == '__main__':
    main()
