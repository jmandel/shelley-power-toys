#!/usr/bin/env python3
"""Branch a conversation from a specific point.

Usage:
    branch                    # Branch current conversation (launches picker)
    branch -c <id>            # Branch specific conversation
    branch --pick             # Browse all conversations first
    branch -c <id> -s <seq>   # Branch directly without UI
"""

import argparse
import os
import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent))
from lib import db


def main():
    parser = argparse.ArgumentParser(description='Branch a conversation')
    parser.add_argument('-c', '--conversation', help='Conversation ID to branch')
    parser.add_argument('-s', '--sequence', type=int, help='Branch at this sequence (skip UI)')
    parser.add_argument('--pick', action='store_true', help='Show conversation picker')
    parser.add_argument('--port', type=int, default=0, help='Port for UI server (0=auto)')
    args = parser.parse_args()
    
    # If sequence provided, branch directly without UI
    if args.sequence is not None:
        conv_id = args.conversation or os.environ.get('SHELLEY_CONVERSATION_ID')
        if not conv_id:
            print("Error: No conversation specified. Use -c or set SHELLEY_CONVERSATION_ID", file=sys.stderr)
            sys.exit(1)
        
        try:
            new_id = db.branch_conversation(conv_id, args.sequence)
            print(f"Created branch: {new_id}")
            print(f"Open at: http://localhost:9999/c/{new_id}")
        except Exception as e:
            print(f"Error: {e}", file=sys.stderr)
            sys.exit(1)
        return
    
    # Otherwise launch the picker UI
    from ui.server import run_branch_picker
    
    conversation_id = args.conversation
    if not conversation_id and not args.pick:
        conversation_id = os.environ.get('SHELLEY_CONVERSATION_ID')
    
    pick = args.pick or not conversation_id
    
    run_branch_picker(
        conversation_id=conversation_id,
        pick_conversation=pick,
        port=args.port if args.port else None
    )


if __name__ == '__main__':
    main()
