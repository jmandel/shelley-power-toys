#!/usr/bin/env python3
"""Branch a conversation from a specific point.

Usage:
    branch                    # Branch current conversation (launches picker)
    branch -c <id>            # Branch specific conversation
    branch --pick             # Browse all conversations first
    branch -c <id> -s <seq>   # Branch directly without UI
"""

import argparse
import os
import subprocess
import sys
import time
from pathlib import Path

SCRIPT_DIR = Path(__file__).parent
sys.path.insert(0, str(SCRIPT_DIR))
from lib import db


def main():
    parser = argparse.ArgumentParser(description='Branch a conversation')
    parser.add_argument('-c', '--conversation', help='Conversation ID to branch')
    parser.add_argument('-s', '--sequence', type=int, help='Branch at this sequence (skip UI)')
    parser.add_argument('--pick', action='store_true', help='Show conversation picker')
    parser.add_argument('--port', type=int, default=0, help='Port for UI server (0=auto)')
    parser.add_argument('--foreground', action='store_true', help='Run server in foreground')
    args = parser.parse_args()
    
    # If sequence provided, branch directly without UI
    if args.sequence is not None:
        conv_id = args.conversation
        if not conv_id:
            print("Error: No conversation specified. Use -c <conversation_id>", file=sys.stderr)
            sys.exit(1)
        
        try:
            new_id = db.branch_conversation(conv_id, args.sequence)
            print(f"Created branch: {new_id}")
            print(f"Open at: http://localhost:9999/c/{new_id}")
        except Exception as e:
            print(f"Error: {e}", file=sys.stderr)
            sys.exit(1)
        return
    
    # Build server command
    server_script = SCRIPT_DIR / 'ui' / 'server.py'
    cmd = [sys.executable, str(server_script)]
    
    # Always start with conversation picker (two-stage flow)
    # If -c is provided, it pre-selects that conversation but still shows picker
    if args.conversation:
        cmd.extend(['-c', args.conversation])
    if args.port:
        cmd.extend(['--port', str(args.port)])
    
    if args.foreground:
        # Run in foreground (blocking)
        os.execv(sys.executable, cmd)
    else:
        # Run in background, capture URL from first line of output
        proc = subprocess.Popen(
            cmd,
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            text=True
        )
        
        # Wait a moment for server to start and print URL
        time.sleep(0.5)
        
        # Read the URL from stdout (server prints it on first line)
        url = None
        try:
            # Non-blocking read
            import select
            if select.select([proc.stdout], [], [], 1.0)[0]:
                url = proc.stdout.readline().strip()
        except:
            pass
        
        if url and url.startswith('http'):
            print(f"Branch picker running at: {url}")
            print(f"")
            print(f"The picker will stay running until you close it (Ctrl+C in terminal)")
            print(f"or it times out after 10 minutes of inactivity.")
        else:
            # Fallback: check stderr
            stderr = proc.stderr.readline()
            if 'http' in stderr:
                print(stderr)
            else:
                print(f"Server started (PID {proc.pid})")
                print(f"Check ports 8100-8199 for the picker UI")


if __name__ == '__main__':
    main()
