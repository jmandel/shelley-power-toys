name: Build and Publish Skill

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate skill structure
        run: |
          # Check required files exist
          test -f SKILL.md || { echo "Missing SKILL.md"; exit 1; }
          test -f LICENSE.txt || { echo "Missing LICENSE.txt"; exit 1; }
          test -d scripts || { echo "Missing scripts/"; exit 1; }
          
          # Validate SKILL.md has required frontmatter
          head -20 SKILL.md | grep -q "^name:" || { echo "SKILL.md missing name"; exit 1; }
          head -20 SKILL.md | grep -q "description:" || { echo "SKILL.md missing description"; exit 1; }
          
          echo "Skill structure validated"
      
      - name: Build skill package
        run: |
          mkdir -p dist
          
          # Create the .skill file (zip with .skill extension)
          zip -r dist/shelley-power-toys.skill \
            SKILL.md \
            LICENSE.txt \
            scripts/ \
            ui/ \
            -x "*.pyc" \
            -x "*__pycache__*" \
            -x "*.git*"
          
          # Also create a versioned copy
          VERSION=$(date +%Y%m%d%H%M%S)
          cp dist/shelley-power-toys.skill dist/shelley-power-toys-${VERSION}.skill
          
          echo "Built: dist/shelley-power-toys.skill"
          ls -la dist/
      
      - name: Create index.html for GitHub Pages
        run: |
          cat > dist/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Shelley Power Toys</title>
            <style>
              body { font-family: system-ui, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
              h1 { border-bottom: 2px solid #333; padding-bottom: 10px; }
              .download { display: inline-block; padding: 12px 24px; background: #0066cc; color: white; text-decoration: none; border-radius: 6px; margin: 20px 0; }
              .download:hover { background: #0055aa; }
              pre { background: #f5f5f5; padding: 16px; border-radius: 6px; overflow-x: auto; }
              code { font-family: monospace; }
            </style>
          </head>
          <body>
            <h1>Shelley Power Toys</h1>
            <p>Power tools for Shelley agent management on exe.dev VMs.</p>
            
            <a href="shelley-power-toys.skill" class="download">Download Skill Package</a>
            
            <h2>Features</h2>
            <ul>
              <li><strong>branch</strong> - Branch conversations with visual picker UI</li>
              <li><strong>spawn</strong> - Create sub-agents in separate context windows</li>
              <li><strong>checkpoint</strong> - Named savepoints within conversations</li>
              <li><strong>memory</strong> - Persistent notes across conversations</li>
              <li><strong>status</strong> - Context window usage monitoring</li>
            </ul>
            
            <h2>Installation</h2>
            <pre><code>git clone https://github.com/exe-dev/shelley-power-toys ~/.shelley-power-toys
export PATH="$PATH:$HOME/.shelley-power-toys/scripts"</code></pre>
            
            <h2>Quick Start</h2>
            <pre><code># Branch a conversation
./scripts/branch

# Spawn a sub-agent
./scripts/spawn "analyze logs"

# Save a checkpoint
./scripts/checkpoint save "before-refactor"

# Store a memory
./scripts/memory set "api-key" "in .env"

# Check status
./scripts/status</code></pre>
            
            <p><a href="https://github.com/exe-dev/shelley-power-toys">View on GitHub</a></p>
          </body>
          </html>
          EOF
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist/

  deploy:
    if: github.ref == 'refs/heads/main'
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
